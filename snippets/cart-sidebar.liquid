{% doc %}
  Renders cart content for slide-over drawer.
  Contains cart items, totals, and checkout actions.

  @param {boolean} [enable_cart_notes] - Whether to show cart notes field

  @example
  {% render 'cart-sidebar' %}
  {% render 'cart-sidebar', enable_cart_notes: true %}
{% enddoc %}

<div class="cart-sidebar-content" data-cart-sidebar>
  {% if cart.item_count > 0 %}
    <!-- Cart Items -->
    {% render 'cart-item', products: cart.items, class: 'cart-drawer-items' %}
    {% comment %} <div class="cart-drawer-items"> {% endcomment %}
      {% comment %} {% for product in cart.items %}
        <div class="cart-drawer-item" data-cart-item="{{ product.key }}">
          <div class="cart-item__image">
            {% if item.image %}
              <img src="{{ item.image | image_url: width: 100 }}" alt="{{ item.title }}" width="100" height="100" loading="lazy">
            {% endif %}
          </div>
          
          <div class="cart-item__content">
            <div class="cart-item__header">
              <h4 class="cart-item__title">
                <a href="{{ item.url }}">{{ item.product.title }}</a>
              </h4>
              <button class="cart-item__remove" data-remove-item="{{ item.key }}" aria-label="{{ 'cart.general.remove_item' | t }}">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </button>
            </div>
            
            {% if item.variant.title != 'Default Title' %}
              <div class="cart-item__variant">
                {{ item.variant.title }}
              </div>
            {% endif %}
            
            <div class="cart-item__footer">
              <div class="cart-item__quantity">
                {% render 'quantity-selector',
                  style_variant: 'compact',
                  input_name: 'updates[]',
                  initial_value: item.quantity,
                  min_value: 0,
                  unique_id: item.key
                %}
              </div>
              
              <div class="cart-item__price">
                {% if item.original_line_price != item.final_line_price %}
                  <span class="cart-item__price--sale">{{ item.final_line_price | money }}</span>
                  <span class="cart-item__price--original">{{ item.original_line_price | money }}</span>
                {% else %}
                  <span>{{ item.final_line_price | money }}</span>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      {% endfor %} {% endcomment %}
    {% comment %} </div> {% endcomment %}

    <!-- Cart Summary -->
    <div class="cart-drawer-summary">
      <div class="cart-summary__line">
        <span>{{ 'cart.general.subtotal' | t }}</span>
        <span>{{ cart.total_price | money }}</span>
      </div>

      {% if cart.total_discount > 0 %}
        <div class="cart-summary__line cart-summary__line--discount">
          <span>{{ 'cart.general.discount' | t }}</span>
          <span>-{{ cart.total_discount | money }}</span>
        </div>
      {% endif %}

      <div class="cart-summary__shipping">
        <span>{{ 'cart.general.shipping' | t }}</span>
        <span class="shipping-note">{{ 'cart.general.shipping_calculated' | t }}</span>
      </div>

      <div class="cart-summary__total">
        <span>{{ 'cart.general.total' | t }}</span>
        <span class="total-price">{{ cart.total_price | money }}</span>
      </div>
    </div>

    <!-- Cart Actions -->
    <div class="cart-drawer-actions">
      <a href="{{ routes.cart_url }}" class="btn btn--secondary btn--full-width">
        {{ 'cart.general.view_cart' | t }}
      </a>
      <button type="submit" name="add" value="checkout" class="btn btn--primary btn--full-width" onclick="document.location='/checkout'">
        {{ 'cart.checkout' | t }}
      </button>
      
      {% if additional_checkout_buttons %}
        <div class="additional-checkout-buttons">
          {{ content_for_additional_checkout_buttons }}
        </div>
      {% endif %}
    </div>

    <!-- Cart Notes -->
    {% if enable_cart_notes %}
      <div class="cart-drawer-notes">
        <label for="cart-note-drawer" class="cart-notes__label">
          {{ 'cart.general.note' | t }}
        </label>
        <textarea
          id="cart-note-drawer"
          name="note"
          class="cart-notes__textarea"
          placeholder="{{ 'cart.general.note_placeholder' | t }}"
        >{{ cart.note }}</textarea>
      </div>
    {% endif %}
  {% else %}
    <!-- Empty Cart -->
    <div class="cart-drawer-empty">
      <div class="cart-empty__content">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <circle cx="9" cy="21" r="1"></circle>
          <circle cx="20" cy="21" r="1"></circle>
          <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
        </svg>
        <h3>{{ 'cart.general.empty' | t }}</h3>
        <p>{{ 'cart.general.empty_text' | t }}</p>
        <a href="{{ routes.all_products_collection_url }}" class="btn btn--primary">
          {{ 'cart.general.continue_shopping' | t }}
        </a>
      </div>
    </div>
  {% endif %}
</div>

{% stylesheet %}
  .cart-sidebar-content {
    display: flex;
    flex-direction: column;
    height: 100%;
    max-height: calc(100vh - 120px);
  }

  .cart-drawer-items {
    flex: 1;
    overflow-y: auto;
    padding: 0 0 20px 0;
    margin-bottom: 20px;
    border-bottom: 1px solid #f0f0f0;
  }

  .cart-drawer-item {
    display: flex;
    gap: 16px;
    padding: 16px 0;
    border-bottom: 1px solid #f8f9fa;
  }

  .cart-drawer-item:last-child {
    border-bottom: none;
  }

  .cart-item__image {
    flex-shrink: 0;
    width: 80px;
    height: 80px;
    border-radius: 8px;
    overflow: hidden;
    background: #f8f9fa;
  }

  .cart-item__image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .cart-item__content {
    flex: 1;
    min-width: 0;
  }

  .cart-item__header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
  }

  .cart-item__title {
    font-size: 14px;
    font-weight: 600;
    margin: 0;
    line-height: 1.3;
  }

  .cart-item__title a {
    color: var(--color-text);
    text-decoration: none;
  }

  .cart-item__title a:hover {
    color: var(--color-primary);
  }

  .cart-item__remove {
    background: none;
    border: none;
    padding: 4px;
    cursor: pointer;
    color: #6c757d;
    transition: color 0.3s ease;
  }

  .cart-item__remove:hover {
    color: #dc3545;
  }

  .cart-item__variant {
    font-size: 12px;
    color: #6c757d;
    margin-bottom: 12px;
  }

  .cart-item__footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .cart-item__price {
    font-size: 14px;
    font-weight: 600;
  }

  .cart-item__price--sale {
    color: #dc3545;
  }

  .cart-item__price--original {
    color: #6c757d;
    text-decoration: line-through;
    font-size: 12px;
    margin-left: 8px;
  }

  .cart-drawer-summary {
    border-bottom: 1px solid #f0f0f0;
    margin-bottom: 1.5rem;
  }

  .cart-summary__line {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    font-size: 14px;
  }

  .cart-summary__line--discount {
    color: #28a745;
    font-weight: 500;
  }

  .cart-summary__shipping {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    font-size: 14px;
  }

  .shipping-note {
    font-size: 12px;
    color: #6c757d;
  }

  .cart-summary__total {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-top: 1px solid #f0f0f0;
    font-size: 16px;
    font-weight: 700;
    margin-top: 12px;
  }

  .total-price {
    color: var(--color-primary);
  }

  .cart-drawer-actions {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 14px 24px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
  }

  .btn--primary {
    background: var(--color-primary);
    color: white;
  }

  .btn--primary:hover {
    background: var(--color-primary-dark, #0056b3);
  }

  .btn--secondary {
    background: #f8f9fa;
    color: var(--color-text);
    border: 1px solid #e9ecef;
  }

  .btn--secondary:hover {
    background: #e9ecef;
  }

  .btn--full-width {
    width: 100%;
  }

  .additional-checkout-buttons {
    margin-top: 12px;
  }

  .cart-drawer-notes {
    padding-top: 20px;
    border-top: 1px solid #f0f0f0;
  }

  .cart-notes__label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--color-text);
  }

  .cart-notes__textarea {
    width: 100%;
    min-height: 80px;
    padding: 12px;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    font-size: 14px;
    line-height: 1.5;
    resize: vertical;
    background: #ffffff;
  }

  .cart-notes__textarea:focus {
    outline: none;
    border-color: var(--color-primary);
  }

  .cart-drawer-empty {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    min-height: 400px;
    text-align: center;
    color: #6c757d;
  }

  .cart-empty__content svg {
    margin-bottom: 20px;
    opacity: 0.5;
  }

  .cart-empty__content h3 {
    font-size: 1.25rem;
    margin: 0 0 12px 0;
    color: var(--color-text);
  }

  .cart-empty__content p {
    margin: 0 0 20px 0;
    font-size: 14px;
  }

  /* Mobile responsive */
  @media (max-width: 480px) {
    .cart-drawer-item {
      gap: 12px;
    }

    .cart-item__image {
      width: 60px;
      height: 60px;
    }

    .cart-item__title {
      font-size: 13px;
    }

    .cart-item__footer {
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }
  }
{% endstylesheet %}

{% comment %} {% javascript %}
  class CartSidebar {
    constructor(element) {
      this.element = element;
      this.init();
    }

    init() {
      // Handle remove item buttons
      const removeButtons = this.element.querySelectorAll('[data-remove-item]');
      removeButtons.forEach(button => {
        button.addEventListener('click', (e) => {
          console.log('Remove item clicked');
          e.preventDefault();
          const itemKey = button.getAttribute('data-remove-item');
          this.removeItem(itemKey);
        });
      });

      // Handle quantity changes
      const quantityInputs = this.element.querySelectorAll('.quantity-selector input');
      quantityInputs.forEach(input => {
        input.addEventListener('change', () => {
          this.updateCart();
        });
      });

      // Handle cart notes
      const cartNote = this.element.querySelector('#cart-note-drawer');
      if (cartNote) {
        cartNote.addEventListener('change', () => {
          this.updateCartNote(cartNote.value);
        });
      }
    }

    async removeItem(itemKey) {
      try {
        const response = await fetch('/cart/change.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            id: itemKey,
            quantity: 0
          })
        });
      } catch (error) {
        console.error('Error removing item:', error);
      }
    }

    async updateCart() {
      // Update cart via AJAX
      const formData = new FormData();
      
      const quantityInputs = this.element.querySelectorAll('.quantity-selector input');
      quantityInputs.forEach((input, index) => {
        formData.append(`updates[${index}]`, input.value);
      });

      try {
        const response = await fetch('/cart/update.js', {
          method: 'POST',
          body: formData
        });
      } catch (error) {
        console.error('Error updating cart:', error);
      }
    }

    async updateCartNote(note) {
      try {
        const response = await fetch('/cart/update.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ note: note })
        });

        if (response.ok) {
          console.log('Cart note updated');
        }
      } catch (error) {
        console.error('Error updating cart note:', error);
      }
    }
  }

  // Auto-initialize cart sidebars
  document.addEventListener('DOMContentLoaded', () => {
    const cartSidebars = document.querySelectorAll('[data-cart-sidebar]');
    cartSidebars.forEach(sidebar => {
      new CartSidebar(sidebar);
    });
  });

  // Re-initialize after content updates
  document.addEventListener('cart-item:updated', () => {
    setTimeout(() => {
      const cartSidebars = document.querySelectorAll('[data-cart-sidebar]');
      cartSidebars.forEach(sidebar => {
        new CartSidebar(sidebar);
      });
    }, 100);
  });
{% endjavascript %} {% endcomment %}