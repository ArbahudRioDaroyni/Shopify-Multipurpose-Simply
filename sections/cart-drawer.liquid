{% comment %}
  This section provides a cart drawer that can be triggered from anywhere
  in the theme. Similar to collection filters but for cart functionality.
{% endcomment %}

{% liquid
  capture cart_content
    render 'cart-sidebar'
  endcapture
%}

<!-- Cart Drawer -->
{% render 'slide-over',
  id: 'cart-drawer',
  position: 'right',
  size: 'lg',
  title: 'Shopping Cart',
  description: 'Review and manage your cart items',
  content: cart_content
%}

{% javascript %}
  class CartSlide {
    constructor() {
      this.init();
    }

    init() {
      document.addEventListener('cart-item:updated', async (e) => {
        // Show loading spinner
        window.theme.Loading.loading(true, '#cart-drawer .cart-sidebar-content', '#cart-drawer .cart-sidebar-content');

        // Extract details from event
        const { id, quantity } = e.detail;

        // Update cart item quantity
        await this._cartChange(id, quantity);

        // Refresh cart drawer content
        const url = new URL('/cart', window.location.origin);
        url.searchParams.set('section_id', 'cart-drawer');
        await window.theme.Section.refresh(url, '.cart-sidebar-content');

        this.openCartDrawer();

        // Re-init CartItem for new elements
        const cartItems = document.querySelectorAll('.cart-item');
        cartItems.forEach(cartItem => {
          new window.theme.CartItem(cartItem);
        });

        // Hide loading spinner
        window.theme.Loading.loading(false, '#cart-drawer .cart-sidebar-content', '#cart-drawer .cart-sidebar-content');
      });
    }

    async _cartChange(keyOrId, quantity) {
      try {
        const response = await fetch('/cart/change.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            id: keyOrId,
            quantity: quantity
          })
        });
      } catch (error) {
        if (this.debug) console.error('Error removing item:', error);
      }
    }

    // async updateCart() {
    //   const formData = new FormData();
      
    //   const quantityInputs = this.element.querySelectorAll('.quantity-selector input');
    //   quantityInputs.forEach((input, index) => {
    //     formData.append(`updates[${index}]`, input.value);
    //   });

    //   try {
    //     const response = await fetch('/cart/update.js', {
    //       method: 'POST',
    //       body: formData
    //     });
    //   } catch (error) {
    //     console.error('Error updating cart:', error);
    //   }
    // }

    openCartDrawer() {
      const cartDrawer = document.getElementById('cart-drawer');
      if (cartDrawer && cartDrawer.open) {
        cartDrawer.open();
      }
    }
  }

  // Initialize cart slide functionality
  document.addEventListener('DOMContentLoaded', () => {
    new CartSlide();
  });
{% endjavascript %}

{% schema %}
{
  "name": "Cart Drawer",
  "settings": [
    {
      "type": "header",
      "content": "Cart drawer settings"
    },
    {
      "type": "checkbox",
      "id": "show_cart_recommendations",
      "label": "Show product recommendations",
      "default": true,
      "info": "Display related products in the cart drawer"
    },
    {
      "type": "checkbox",
      "id": "enable_cart_notes",
      "label": "Enable cart notes",
      "default": true,
      "info": "Allow customers to add notes to their order"
    }
  ]
}
{% endschema %}