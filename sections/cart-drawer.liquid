{% comment %}
  This section provides a cart drawer that can be triggered from anywhere
  in the theme. Similar to collection filters but for cart functionality.
{% endcomment %}
{% assign enable_cart_notes = section.settings.enable_cart_notes %}

{% capture cart_content %}
  <div class="cart-sidebar-content" data-cart-sidebar>
    {% if cart.item_count > 0 %}
      <!-- Cart Items -->
      {% render 'cart-item', products: cart.items, class: 'cart-drawer-items' %}
    {% else %}
      <!-- Empty Cart -->
      <div class="cart-drawer-empty">
        <div class="cart-empty__content">
          <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="9" cy="21" r="1"></circle>
            <circle cx="20" cy="21" r="1"></circle>
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
          </svg>
          <h3>{{ 'cart.general.empty' | t }}</h3>
          <p>{{ 'cart.general.empty_text' | t }}</p>
          <a href="{{ routes.all_products_collection_url }}" class="btn btn--primary">
            {{ 'cart.general.continue_shopping' | t }}
          </a>
        </div>
      </div>
    {% endif %}
  </div>
{% endcapture %}

{% capture cart_footer %}
  <!-- Cart Summary -->
  <div class="cart-drawer-summary">
    <div class="cart-summary__line">
      <span>{{ 'cart.general.subtotal' | t }}</span>
      <span>{{ cart.total_price | money }}</span>
    </div>

    {% if cart.total_discount > 0 %}
      <div class="cart-summary__line cart-summary__line--discount">
        <span>{{ 'cart.general.discount' | t }}</span>
        <span>-{{ cart.total_discount | money }}</span>
      </div>
    {% endif %}

    <div class="cart-summary__shipping">
      <span>{{ 'cart.general.shipping' | t }}</span>
      <span class="shipping-note">{{ 'cart.general.shipping_calculated' | t }}</span>
    </div>

    <div class="cart-summary__total">
      <span>{{ 'cart.general.total' | t }}</span>
      <span class="total-price">{{ cart.total_price | money }}</span>
    </div>
  </div>

  <!-- Cart Actions -->
  <div class="cart-drawer-actions">
    <a href="{{ routes.cart_url }}" class="btn btn--secondary btn--full-width">
      {{ 'cart.general.view_cart' | t }}
    </a>
    <button type="submit" name="add" value="checkout" class="btn btn--primary btn--full-width" onclick="document.location='/checkout'">
      {{ 'cart.checkout' | t }}
    </button>
    
    {% if additional_checkout_buttons %}
      <div class="additional-checkout-buttons">
        {{ content_for_additional_checkout_buttons }}
      </div>
    {% endif %}
  </div>

  <!-- Cart Notes -->
  {% if enable_cart_notes %}
    <div class="cart-drawer-notes">
      <label for="cart-note-drawer" class="cart-notes__label">
        {{ 'cart.general.note' | t }}
      </label>
      <textarea
        id="cart-note-drawer"
        name="note"
        class="cart-notes__textarea"
        placeholder="{{ 'cart.general.note_placeholder' | t }}"
      >{{ cart.note }}</textarea>
    </div>
  {% endif %}
{% endcapture %}

<!-- Cart Drawer -->
{% render 'slide-over',
  id: 'cart-drawer',
  position: 'right',
  size: 'lg',
  title: 'Shopping Cart',
  description: 'Review and manage your cart items',
  content: cart_content,
  footer: cart_footer
%}

{% javascript %}
  class CartSlide {
    constructor() {
      this.init();
    }

    init() {
      document.addEventListener('cart-item:updated', async (e) => {
        // Show loading spinner
        window.theme.Loading.loading(true, '#cart-drawer .cart-sidebar-content', '#cart-drawer .cart-sidebar-content');

        // Extract details from event
        const { id, quantity } = e.detail;

        // Update cart item quantity
        await this._cartChange(id, quantity);

        // Refresh cart drawer content
        const url = new URL('/cart', window.location.origin);
        url.searchParams.set('section_id', 'cart-drawer');
        await window.theme.Section.refresh(url, ['.slide-over__body', '.slide-over__footer']);

        this.openCartDrawer();

        // Re-init CartItem for new elements
        const cartItems = document.querySelectorAll('.cart-item');
        cartItems.forEach(cartItem => {
          new window.theme.CartItem(cartItem);
        });

        // Hide loading spinner
        window.theme.Loading.loading(false, '#cart-drawer .cart-sidebar-content', '#cart-drawer .cart-sidebar-content');
      });
    }

    async _cartChange(keyOrId, quantity) {
      try {
        const response = await fetch('/cart/change.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            id: keyOrId,
            quantity: quantity
          })
        });
      } catch (error) {
        if (this.debug) console.error('Error removing item:', error);
      }
    }

    // async updateCart() {
    //   const formData = new FormData();
      
    //   const quantityInputs = this.element.querySelectorAll('.quantity-selector input');
    //   quantityInputs.forEach((input, index) => {
    //     formData.append(`updates[${index}]`, input.value);
    //   });

    //   try {
    //     const response = await fetch('/cart/update.js', {
    //       method: 'POST',
    //       body: formData
    //     });
    //   } catch (error) {
    //     console.error('Error updating cart:', error);
    //   }
    // }

    openCartDrawer() {
      const cartDrawer = document.getElementById('cart-drawer');
      if (cartDrawer && cartDrawer.open) {
        cartDrawer.open();
      }
    }
  }

  // Initialize cart slide functionality
  document.addEventListener('DOMContentLoaded', () => {
    new CartSlide();
  });
{% endjavascript %}

{% schema %}
{
  "name": "Cart Drawer",
  "settings": [
    {
      "type": "header",
      "content": "Cart drawer settings"
    },
    {
      "type": "checkbox",
      "id": "show_cart_recommendations",
      "label": "Show product recommendations",
      "default": true,
      "info": "Display related products in the cart drawer"
    },
    {
      "type": "checkbox",
      "id": "enable_cart_notes",
      "label": "Enable cart notes",
      "default": true,
      "info": "Allow customers to add notes to their order"
    }
  ]
}
{% endschema %}